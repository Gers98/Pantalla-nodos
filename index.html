<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>PAAC System | Mapa de Asistentes en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Orbitron:wght@500;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --paac-blue: #5182df;
      --paac-purple: #4d1ea2;
      --bg-dark: #050712;
      --text-main: #f5f7ff;
      --text-muted: #a9b0d9;
      --accent: #00e0ff;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      font-family: "Montserrat", system-ui, sans-serif;
      background: radial-gradient(circle at top left, #121633, #050712 55%);
      color: var(--text-main);
    }

    .background-orbit {
      position: fixed;
      inset: 0;
      z-index: -2;
      overflow: hidden;
    }

    #bg-canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at top left, #050712, #02030a 60%);
    }

    .gradient-orb {
      position: absolute;
      width: 700px;
      height: 700px;
      background: radial-gradient(circle, var(--paac-blue), transparent 60%);
      filter: blur(18px);
      opacity: 0.3;
      animation: orb-float-1 22s ease-in-out infinite alternate;
      pointer-events: none;
    }

    .gradient-orb.orb-2 {
      width: 900px;
      height: 900px;
      background: radial-gradient(circle, var(--paac-purple), transparent 65%);
      top: auto;
      bottom: -260px;
      right: -220px;
      left: auto;
      animation: orb-float-2 28s ease-in-out infinite alternate;
      opacity: 0.4;
    }

    .grid-lines {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(
          rgba(255, 255, 255, 0.04) 1px,
          transparent 1px
        ),
        linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.04) 1px,
          transparent 1px
        );
      background-size: 70px 70px;
      opacity: 0.16;
      mask-image: radial-gradient(circle at center, black 0%, transparent 75%);
      pointer-events: none;
    }

    @keyframes orb-float-1 {
      from { transform: translate(-150px, -100px); }
      to { transform: translate(80px, 60px); }
    }

    @keyframes orb-float-2 {
      from { transform: translate(80px, 60px); }
      to { transform: translate(-100px, -60px); }
    }

    .shell {
      position: relative;
      z-index: 1;
      width: 100%;
      height: 100%;
      padding: 14px 24px 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .brand-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0, 224, 255, 0.5);
      background: radial-gradient(
        circle at left,
        rgba(0, 224, 255, 0.18),
        transparent 70%
      );
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .brand-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 13px rgba(0, 224, 255, 0.9);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .page-title {
      font-family: "Orbitron", system-ui, sans-serif;
      font-size: clamp(1.5rem, 3vw, 2.3rem);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .page-title span {
      background: linear-gradient(120deg, var(--paac-blue), var(--paac-purple));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .subtitle strong {
      color: var(--accent);
    }

    .status-header {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: right;
    }

    .status-header span {
      color: var(--accent);
      font-weight: 600;
    }

    .main-area {
      flex: 1;
      position: relative;
      border-radius: 24px;
      border: 1px solid rgba(140, 174, 255, 0.5);
      background: radial-gradient(circle at center, #050712, #02030b);
      overflow: hidden;
      box-shadow: 0 22px 55px rgba(0, 0, 0, 0.8);
    }

    #graph-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    .graph-label {
      position: absolute;
      left: 16px;
      top: 12px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid rgba(0, 224, 255, 0.5);
      background: radial-gradient(
        circle at left,
        rgba(0, 224, 255, 0.16),
        transparent 70%
      );
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .graph-label-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: rgba(0, 224, 255, 1);
      box-shadow: 0 0 10px rgba(0, 224, 255, 0.95);
    }

    /* Banner de bienvenida */
    .welcome-banner {
      position: absolute;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      min-width: 40%;
      max-width: 80%;
      padding: 10px 20px;
      border-radius: 999px;
      background: linear-gradient(
        120deg,
        rgba(81, 130, 223, 0.9),
        rgba(0, 224, 255, 0.95),
        rgba(77, 30, 162, 0.9)
      );
      border: 1px solid rgba(220, 240, 255, 0.8);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 1rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s ease-out, transform 0.5s ease-out;
      white-space: nowrap;
    }

    .welcome-banner.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .welcome-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: #ffffff;
      box-shadow: 0 0 16px rgba(255, 255, 255, 0.9);
    }

    .welcome-main-text {
      font-weight: 600;
    }

    .welcome-name {
      font-family: "Orbitron", system-ui, sans-serif;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .welcome-company {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    /* Barra inferior info ligera */
    .footer-bar {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      padding: 0 4px;
    }

    .footer-bar span strong {
      color: var(--accent);
    }

    @media (max-width: 900px) {
      .subtitle {
        font-size: 0.8rem;
      }
      .footer-bar {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Fondo IA -->
  <div class="background-orbit">
    <canvas id="bg-canvas"></canvas>
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <div class="grid-lines"></div>
  </div>

  <div class="shell">
    <header class="header">
      <div class="title-block">
        <div class="brand-pill">
          <div class="brand-dot"></div>
          PAAC System ‚Ä¢ IA en acci√≥n
        </div>
        <div class="page-title">
          Mapa vivo de <span>Asistentes</span>
        </div>
        <div class="subtitle">
          Cada nodo representa una <strong>empresa</strong> conectada al ecosistema de
          <strong>Inteligencia Artificial</strong> de PAAC System.
        </div>
      </div>
      <div class="status-header" id="status-header">
        Asistentes registrados: <span>0</span><br />
        Actualizando en tiempo real...
      </div>
    </header>

    <main class="main-area">
      <canvas id="graph-canvas"></canvas>
      <div class="graph-label">
        <div class="graph-label-dot"></div>
        Red din√°mica de empresas participantes
      </div>
      <div id="welcome-banner" class="welcome-banner">
        <div class="welcome-dot"></div>
        <div>
          <div class="welcome-main-text">
            Bienvenido(a), <span id="welcome-name" class="welcome-name">Asistente</span>
          </div>
          <div class="welcome-company">
            Representando a: <span id="welcome-company">Empresa</span>
          </div>
        </div>
      </div>
    </main>

    <footer class="footer-bar">
      <span>Visualizaci√≥n tipo <strong>grafo din√°mico</strong>, inspirada en mapas de conocimiento como Obsidian.</span>
      <span>Datos capturados desde el m√≥dulo de registro de <strong>PAAC System</strong> en tiempo real.</span>
    </footer>
  </div>

  <script>
  /************************************
   * Fondo de red neuronal suave
   ************************************/
  const bgCanvas = document.getElementById("bg-canvas");
  const bgCtx = bgCanvas.getContext("2d");

  let bgPoints = [];
  const BG_POINTS = 60;
  const BG_MAX_DIST = 170;

  function resizeBg() {
    bgCanvas.width = window.innerWidth;
    bgCanvas.height = window.innerHeight;
  }

  window.addEventListener("resize", resizeBg);
  resizeBg();

  function initBgPoints() {
    bgPoints = [];
    for (let i = 0; i < BG_POINTS; i++) {
      bgPoints.push({
        x: Math.random() * bgCanvas.width,
        y: Math.random() * bgCanvas.height,
        vx: (Math.random() - 0.5) * 0.25,
        vy: (Math.random() - 0.5) * 0.25,
      });
    }
  }
  initBgPoints();

  function drawBg() {
    bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);

    bgPoints.forEach((p, i) => {
      p.x += p.vx;
      p.y += p.vy;

      if (p.x < 0 || p.x > bgCanvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > bgCanvas.height) p.vy *= -1;

      bgCtx.fillStyle = "rgba(0,224,255,0.7)";
      bgCtx.beginPath();
      bgCtx.arc(p.x, p.y, 1.8, 0, Math.PI * 2);
      bgCtx.fill();

      for (let j = i + 1; j < bgPoints.length; j++) {
        const q = bgPoints[j];
        const dx = p.x - q.x;
        const dy = p.y - q.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < BG_MAX_DIST) {
          const alpha = 1 - dist / BG_MAX_DIST;
          bgCtx.strokeStyle = "rgba(0,224,255," + (alpha * 0.4) + ")";
          bgCtx.lineWidth = 0.6;
          bgCtx.beginPath();
          bgCtx.moveTo(p.x, p.y);
          bgCtx.lineTo(q.x, q.y);
          bgCtx.stroke();
        }
      }
    });

    requestAnimationFrame(drawBg);
  }
  drawBg();

  /************************************
   * Grafo de empresas (nodos flotantes)
   ************************************/
  const graphCanvas = document.getElementById("graph-canvas");
  const graphCtx = graphCanvas.getContext("2d");

  function resizeGraph() {
    const rect = graphCanvas.getBoundingClientRect();
    graphCanvas.width = rect.width * window.devicePixelRatio;
    graphCanvas.height = rect.height * window.devicePixelRatio;
    graphCtx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
  }

  window.addEventListener("resize", resizeGraph);
  setTimeout(resizeGraph, 200);

  const nodes = [];
  const knownDocs = new Set(); // para no repetir personas
  const statusHeader = document.getElementById("status-header");
  const welcomeBanner = document.getElementById("welcome-banner");
  const welcomeNameEl = document.getElementById("welcome-name");
  const welcomeCompanyEl = document.getElementById("welcome-company");

  const footerBar = document.querySelector(".footer-bar"); // para mensajes extra

  const POLL_INTERVAL_MS = 5000; // cada 5 s

  // üëâ URL CSV de tu hoja (ya con el gid correcto)
  const SHEET_CSV_URL =
    "https://docs.google.com/spreadsheets/d/1hgjqPTNz2aV4XX7TIKqwWKPUkFFQyZJJCKVU-VI9KT8/export?format=csv&gid=1830882299";

  function setHeaderCount(count) {
    statusHeader.innerHTML =
      "Asistentes registrados: <span>" + count + "</span><br />" +
      "Actualizando en tiempo real...";
  }

  function showWelcome(name, company) {
    welcomeNameEl.textContent = name || "Asistente";
    welcomeCompanyEl.textContent = company || "Empresa";
    welcomeBanner.classList.add("visible");

    setTimeout(() => {
      welcomeBanner.classList.remove("visible");
    }, 4500);
  }

  function addNodeForParticipant(participant) {
    const rect = graphCanvas.getBoundingClientRect();
    const width = rect.width || 800;
    const height = rect.height || 400;

    const centerX = width / 2;
    const centerY = height / 2;
    const radiusBase = Math.min(width, height) * 0.32;

    const angle = Math.random() * Math.PI * 2;
    const r = radiusBase + (Math.random() - 0.5) * 60;

    const x = centerX + r * Math.cos(angle);
    const y = centerY + r * Math.sin(angle);

    nodes.push({
      id: participant.doc || (participant.nombre + "_" + Date.now()),
      label: participant.empresa || "Empresa",
      x,
      y,
      vx: (Math.random() - 0.5) * 0.4,
      vy: (Math.random() - 0.5) * 0.4,
      radius: 18 + Math.min(20, (participant.empresa || "").length),
      alpha: 1,
    });
  }

  function drawGraph(timestamp) {
    const rect = graphCanvas.getBoundingClientRect();
    const width = rect.width;
    const height = rect.height;

    graphCtx.clearRect(0, 0, width, height);

    // actualizar posiciones
    nodes.forEach((node) => {
      node.x += node.vx;
      node.y += node.vy;

      // rebotes suaves
      if (node.x < 40 || node.x > width - 40) node.vx *= -1;
      if (node.y < 40 || node.y > height - 40) node.vy *= -1;
    });

    // dibujar conexiones
    const maxDist = Math.min(width, height) * 0.45;
    for (let i = 0; i < nodes.length; i++) {
      for (let j = i + 1; j < nodes.length; j++) {
        const n1 = nodes[i];
        const n2 = nodes[j];
        const dx = n1.x - n2.x;
        const dy = n1.y - n2.y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < maxDist) {
          const alpha = 0.14 * (1 - dist / maxDist);
          graphCtx.strokeStyle = "rgba(0,224,255," + alpha + ")";
          graphCtx.lineWidth = 1;
          graphCtx.beginPath();
          graphCtx.moveTo(n1.x, n1.y);
          graphCtx.lineTo(n2.x, n2.y);
          graphCtx.stroke();
        }
      }
    }

    // dibujar nodos
    const time = (timestamp || 0) / 800;
    nodes.forEach((node, idx) => {
      const pulse = 1 + 0.1 * Math.sin(time + idx);
      const r = node.radius * pulse;

      // c√≠rculo
      graphCtx.save();
      graphCtx.shadowColor = "rgba(0,224,255,0.9)";
      graphCtx.shadowBlur = 20;
      graphCtx.fillStyle = "rgba(0,224,255,0.82)";
      graphCtx.beginPath();
      graphCtx.arc(node.x, node.y, r, 0, Math.PI * 2);
      graphCtx.fill();
      graphCtx.restore();

      // c√≠rculo interior
      graphCtx.fillStyle = "rgba(5,7,18,0.98)";
      graphCtx.beginPath();
      graphCtx.arc(node.x, node.y, r * 0.7, 0, Math.PI * 2);
      graphCtx.fill();

      // texto (empresa)
      const label = node.label || "Empresa";
      graphCtx.fillStyle = "#f5f7ff";
      graphCtx.font = "600 12px 'Montserrat', system-ui";
      graphCtx.textAlign = "center";
      graphCtx.textBaseline = "middle";

      if (label.length > 16) {
        const mid = Math.ceil(label.length / 2);
        const part1 = label.slice(0, mid);
        const part2 = label.slice(mid);
        graphCtx.fillText(part1, node.x, node.y - 6);
        graphCtx.fillText(part2, node.x, node.y + 8);
      } else {
        graphCtx.fillText(label, node.x, node.y);
      }
    });

    requestAnimationFrame(drawGraph);
  }
  drawGraph();

  /************************************
   * Helper para parsear CSV (coma o punto y coma)
   ************************************/
  function parseCsv(text) {
    const lines = text
      .split(/\r?\n/)
      .map((l) => l.trim())
      .filter((l) => l.length > 0);

    if (lines.length <= 1) {
      return { headers: [], rows: [] };
    }

    const headerLine = lines[0];

    // Detectar si separa por ; o por ,
    const countComa = headerLine.split(",").length;
    const countPuntoComa = headerLine.split(";").length;
    const delim = countPuntoComa > countComa ? ";" : ",";

    const splitLine = (line) => line.split(delim);

    const headers = splitLine(headerLine);
    const rows = lines.slice(1).map(splitLine);

    return { headers, rows };
  }

  /************************************
   * Polling de Google Sheets (CSV)
   ************************************/
  function findColumnIndexes(headersRaw) {
    const headers = headersRaw.map((h) => h.toLowerCase());

    const idxNombre = headers.findIndex((h) => h.includes("nombre"));
    const idxDoc = headers.findIndex((h) => h.includes("documento"));
    const idxTel = headers.findIndex(
      (h) => h.includes("celular") || h.includes("tel")
    );
    const idxCiudad = headers.findIndex((h) => h.includes("ciudad"));
    const idxEmpresa = headers.findIndex(
      (h) => h.includes("empresa") || h.includes("representas")
    );
    const idxCorreo = headers.findIndex(
      (h) => h.includes("correo") || h.includes("email")
    );
    const idxInteres = headers.findIndex(
      (h) => h.includes("inter√©s") || h.includes("interes")
    );

    return {
      idxNombre,
      idxDoc,
      idxTel,
      idxCiudad,
      idxEmpresa,
      idxCorreo,
      idxInteres,
    };
  }

  async function pollSheet() {
    try {
      const resp = await fetch(SHEET_CSV_URL + "&t=" + Date.now());
      if (!resp.ok) {
        console.error("Error HTTP al leer CSV:", resp.status);
        return;
      }
      const text = await resp.text();

      const { headers, rows } = parseCsv(text);

      if (!headers.length || !rows.length) {
        setHeaderCount(0);
        return;
      }

      const {
        idxNombre,
        idxDoc,
        idxTel,
        idxCiudad,
        idxEmpresa,
        idxCorreo,
        idxInteres,
      } = findColumnIndexes(headers);

      // Si no encontramos al menos nombre y documento, mostramos aviso
      if (idxNombre === -1 || idxDoc === -1) {
        if (footerBar) {
          footerBar.lastElementChild.innerHTML =
            "No se encontraron columnas de <strong>nombre</strong> y/o <strong>documento</strong> en el CSV. Revisa los encabezados.";
        }
        return;
      }

      let nuevos = 0;

      rows.forEach((colsRaw) => {
        const cols = colsRaw;

        const nombre = cols[idxNombre] || "";
        const doc = cols[idxDoc] || "";
        const tel = idxTel !== -1 ? cols[idxTel] || "" : "";
        const ciudad = idxCiudad !== -1 ? cols[idxCiudad] || "" : "";
        const empresa = idxEmpresa !== -1 ? cols[idxEmpresa] || "" : "";
        const correo = idxCorreo !== -1 ? cols[idxCorreo] || "" : "";
        const interes = idxInteres !== -1 ? cols[idxInteres] || "" : "";

        if (!nombre || !doc) return;

        if (!knownDocs.has(doc)) {
          knownDocs.add(doc);
          nuevos++;

          const participant = {
            nombre,
            doc,
            tel,
            ciudad,
            empresa,
            correo,
            interes,
          };

          addNodeForParticipant(participant);
          showWelcome(nombre, empresa);
        }
      });

      setHeaderCount(knownDocs.size);

      if (footerBar && knownDocs.size > 0) {
        footerBar.lastElementChild.innerHTML =
          "Datos capturados desde el m√≥dulo de registro de <strong>PAAC System</strong>. √öltima actualizaci√≥n correcta.";
      }
    } catch (err) {
      console.error("Error al leer CSV:", err);
      if (footerBar) {
        footerBar.lastElementChild.innerHTML =
          "No se pudo leer el CSV (verifica permisos de la hoja y conexi√≥n).";
      }
    }
  }

  // Polling peri√≥dico
  setInterval(pollSheet, POLL_INTERVAL_MS);
  // Primer intento al cargar
  pollSheet();
</script>

</body>
</html>
